<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>VK Messenger</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Все стили из предыдущей версии остаются */
        /* Добавляем стили для голосовых сообщений и файлов */
        
        .voice-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 15px;
            background: rgba(74, 118, 168, 0.1);
            border-radius: 20px;
            min-width: 120px;
            max-width: 200px;
        }

        .voice-play-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
        }

        .voice-duration {
            font-size: 14px;
            color: #666;
            flex-shrink: 0;
        }

        .voice-waveform {
            flex: 1;
            height: 20px;
            background: linear-gradient(90deg, var(--primary-color) 50%, transparent 50%);
            background-size: 4px 100%;
            border-radius: 10px;
            opacity: 0.6;
        }

        .file-message {
            padding: 12px;
            background: rgba(74, 118, 168, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(74, 118, 168, 0.2);
            max-width: 250px;
        }

        .file-icon {
            font-size: 24px;
            color: var(--primary-color);
            margin-bottom: 5px;
        }

        .file-name {
            font-weight: 600;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .file-size {
            font-size: 12px;
            color: #666;
            margin-bottom: 8px;
        }

        .file-download {
            display: inline-block;
            padding: 6px 12px;
            background: var(--primary-color);
            color: white;
            text-decoration: none;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 500;
        }

        .voice-recorder {
            display: none;
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 1000;
            align-items: center;
            gap: 15px;
            min-width: 250px;
        }

        .voice-recorder.recording {
            background: #ffebee;
            border: 2px solid #ff4444;
        }

        .voice-timer {
            font-size: 18px;
            font-weight: 600;
            min-width: 50px;
            text-align: center;
            color: #ff4444;
        }

        .voice-wave {
            display: flex;
            align-items: center;
            gap: 2px;
            height: 20px;
        }

        .voice-bar {
            width: 3px;
            background: var(--primary-color);
            border-radius: 2px;
            animation: wave 0.5s ease-in-out infinite alternate;
        }

        @keyframes wave {
            0% { height: 5px; }
            100% { height: 20px; }
        }

        .tool-btn.recording {
            background: #ff4444;
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div class="login-screen" id="authScreen">
        <div class="auth-container">
            <h2 style="margin-bottom: 30px; color: var(--primary-color); text-align: center;">VK Messenger</h2>
            
            <div class="auth-tabs">
                <button class="auth-tab active" onclick="showAuthTab('login')">Вход</button>
                <button class="auth-tab" onclick="showAuthTab('register')">Регистрация</button>
            </div>

            <!-- Форма входа -->
            <div class="auth-form active" id="loginForm">
                <input type="text" class="auth-input" id="loginUsername" placeholder="Имя пользователя" maxlength="20">
                <input type="password" class="auth-input" id="loginPassword" placeholder="Пароль">
                <button class="auth-btn" onclick="login()" id="loginBtn">Войти</button>
                <div id="loginMessage" class="auth-message"></div>
            </div>

            <!-- Форма регистрации -->
            <div class="auth-form" id="registerForm">
                <input type="text" class="auth-input" id="registerUsername" placeholder="Имя пользователя" maxlength="20">
                <input type="password" class="auth-input" id="registerPassword" placeholder="Пароль">
                <input type="password" class="auth-input" id="registerConfirmPassword" placeholder="Подтвердите пароль">
                <button class="auth-btn" onclick="register()" id="registerBtn">Зарегистрироваться</button>
                <div id="registerMessage" class="auth-message"></div>
            </div>
        </div>
    </div>

    <!-- Overlay для мобильного меню -->
    <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

    <!-- Main App -->
    <div class="app-container" id="appContainer">
        <!-- Sidebar -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <button class="menu-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div>
                        <div id="currentUsername">Пользователь</div>
                        <div style="font-size: 12px; opacity: 0.8;">онлайн</div>
                    </div>
                </div>
                <button class="call-btn audio-call-btn" onclick="startGroupCall('audio')" title="Групповой аудиозвонок">
                    <i class="fas fa-phone"></i>
                </button>
            </div>

            <div class="sidebar-menu">
                <div class="menu-item active">
                    <i class="fas fa-comments"></i>
                    <span>Общий чат</span>
                </div>
                <div class="menu-item">
                    <i class="fas fa-users"></i>
                    <span>Группы</span>
                </div>
                <div class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span>Настройки</span>
                </div>
            </div>

            <div class="online-users">
                <h3 style="margin-bottom: 15px; font-size: 14px; color: #666;">Онлайн сейчас</h3>
                <div id="onlineUsersList">
                    <!-- Online users will appear here -->
                </div>
            </div>
        </div>

        <!-- Main Chat -->
        <div class="main-chat">
            <div class="chat-header">
                <button class="menu-toggle" onclick="toggleSidebar()" style="display: none;">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="chat-user-info">
                    <div class="user-avatar-small" style="background: var(--primary-color);">
                        <i class="fas fa-users"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600;">Общий чат</div>
                        <div style="font-size: 12px; color: #666;" id="onlineCount">0 участников онлайн</div>
                    </div>
                </div>
                <div class="call-buttons">
                    <button class="call-btn video-call-btn" onclick="startGroupCall('video')" title="Групповой видеозвонок">
                        <i class="fas fa-video"></i>
                    </button>
                </div>
            </div>

            <div class="messages-container" id="messagesContainer">
                <div class="system-message">Добро пожаловать в чат!</div>
            </div>

            <div class="input-area">
                <div class="input-tools">
                    <button class="tool-btn" onclick="toggleVoiceRecord()" id="voiceRecordBtn">
                        <i class="fas fa-microphone"></i>
                    </button>
                    <input type="file" id="fileInput" style="display: none;" accept="*/*">
                    <button class="tool-btn" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-paperclip"></i>
                    </button>
                </div>
                <input type="text" class="message-input" id="messageInput" placeholder="Сообщение..." maxlength="1000">
                <button class="send-btn" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Voice Recorder -->
    <div class="voice-recorder" id="voiceRecorder">
        <div class="voice-timer" id="voiceTimer">0:00</div>
        <div class="voice-wave" id="voiceWave">
            <!-- Волны будут добавляться через JS -->
        </div>
        <button class="voice-cancel-btn" onclick="cancelVoiceRecord()">
            <i class="fas fa-times"></i>
        </button>
        <button class="voice-send-btn" onclick="sendVoiceMessage()">
            <i class="fas fa-check"></i>
        </button>
    </div>

    <!-- Call Interface -->
    <div class="call-interface" id="callInterface">
        <div class="call-header">
            <div class="caller-name" id="callerName">Абонент</div>
            <div class="call-status" id="callStatus">Идет звонок...</div>
        </div>
        <div class="video-container">
            <video id="remoteVideo" autoplay playsinline class="remote-video"></video>
            <video id="localVideo" autoplay playsinline muted class="local-video"></video>
        </div>
        <div class="call-controls">
            <button class="control-btn toggle-audio" id="toggleAudio" onclick="toggleAudio()">
                <i class="fas fa-microphone"></i>
            </button>
            <button class="control-btn toggle-video" id="toggleVideo" onclick="toggleVideo()">
                <i class="fas fa-video"></i>
            </button>
            <button class="control-btn end-call" onclick="endCall()">
                <i class="fas fa-phone-slash"></i>
            </button>
        </div>
    </div>

    <!-- Incoming Call -->
    <div class="incoming-call" id="incomingCall">
        <div class="incoming-call-content">
            <div class="caller-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="caller-name" id="incomingCallerName">Абонент</div>
            <div class="call-status">Входящий вызов</div>
            <div class="call-controls" style="margin-top: 30px;">
                <button class="control-btn accept-call" onclick="acceptCall()">
                    <i class="fas fa-phone"></i>
                </button>
                <button class="control-btn end-call" onclick="rejectCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Установка высоты для мобильных устройств
        function setVH() {
            let vh = window.innerHeight * 0.01;
            document.documentElement.style.setProperty('--vh', `${vh}px`);
        }
        setVH();
        window.addEventListener('resize', setVH);
        window.addEventListener('orientationchange', setVH);

        let socket;
        let currentUser = null;
        let mediaRecorder;
        let audioChunks = [];
        let voiceTimer;
        let voiceSeconds = 0;
        let audioContext;
        let analyser;
        let isRecording = false;

        function showAuthTab(tab) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tab + 'Form').classList.add('active');
            
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('registerMessage').textContent = '';
        }

        async function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            const messageDiv = document.getElementById('loginMessage');

            if (!username || !password) {
                showMessage(messageDiv, 'Заполните все поля', 'error');
                return;
            }

            loginBtn.disabled = true;
            loginBtn.textContent = 'Вход...';

            try {
                const response = await fetch('/api/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    currentUser = result.user;
                    showMessage(messageDiv, result.message, 'success');
                    
                    setTimeout(() => {
                        document.getElementById('authScreen').style.display = 'none';
                        document.getElementById('appContainer').style.display = 'flex';
                        initializeChat();
                    }, 1000);
                    
                } else {
                    showMessage(messageDiv, result.message, 'error');
                }
            } catch (error) {
                console.error('Login error:', error);
                showMessage(messageDiv, 'Ошибка подключения к серверу', 'error');
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'Войти';
            }
        }

        async function register() {
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const registerBtn = document.getElementById('registerBtn');
            const messageDiv = document.getElementById('registerMessage');

            if (!username || !password || !confirmPassword) {
                showMessage(messageDiv, 'Заполните все поля', 'error');
                return;
            }

            if (password !== confirmPassword) {
                showMessage(messageDiv, 'Пароли не совпадают', 'error');
                return;
            }

            registerBtn.disabled = true;
            registerBtn.textContent = 'Регистрация...';

            try {
                const response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ username, password })
                });

                const result = await response.json();
                
                if (result.success) {
                    showMessage(messageDiv, result.message, 'success');
                    document.getElementById('registerUsername').value = '';
                    document.getElementById('registerPassword').value = '';
                    document.getElementById('registerConfirmPassword').value = '';
                    setTimeout(() => showAuthTab('login'), 2000);
                } else {
                    showMessage(messageDiv, result.message, 'error');
                }
            } catch (error) {
                console.error('Register error:', error);
                showMessage(messageDiv, 'Ошибка подключения к серверу', 'error');
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Зарегистрироваться';
            }
        }

        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = 'auth-message ' + type;
        }

        function initializeChat() {
            socket = io();
            socket.emit('user_online', { 
                username: currentUser.username,
                color: currentUser.color
            });

            document.getElementById('currentUsername').textContent = currentUser.username;
            setupSocketListeners();
            
            // Настройка обработчика файлов
            document.getElementById('fileInput').addEventListener('change', handleFileSelect);
        }

        function setupSocketListeners() {
            socket.on('users_online', (users) => {
                updateOnlineUsers(users.filter(u => u.username !== currentUser.username));
                document.getElementById('onlineCount').textContent = 
                    `${users.length} участников онлайн`;
            });

            socket.on('new_message', (message) => {
                addMessage(message.sender, message.text, false);
            });

            socket.on('new_voice_message', (message) => {
                addVoiceMessage(message.sender, message.voiceUrl, message.duration, false);
            });

            socket.on('new_file_message', (message) => {
                addFileMessage(message.sender, message.fileName, message.fileUrl, message.fileSize, message.fileType, false);
            });

            socket.on('user_joined', (username) => {
                addSystemMessage(`${username} присоединился к чату`);
            });

            socket.on('user_left', (username) => {
                addSystemMessage(`${username} покинул чат`);
            });

            // Остальные обработчики...
        }

        // Реальные голосовые сообщения
        async function toggleVoiceRecord() {
            if (isRecording) {
                stopVoiceRecord();
            } else {
                startVoiceRecord();
            }
        }

        async function startVoiceRecord() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    } 
                });
                
                mediaRecorder = new MediaRecorder(stream, {
                    mimeType: 'audio/webm;codecs=opus'
                });
                
                audioChunks = [];
                mediaRecorder.ondataavailable = (event) => {
                    audioChunks.push(event.data);
                };

                mediaRecorder.start(100); // Записываем каждые 100ms
                isRecording = true;
                
                // Визуализация записи
                document.getElementById('voiceRecordBtn').classList.add('recording');
                document.getElementById('voiceRecorder').style.display = 'flex';
                document.getElementById('voiceRecorder').classList.add('recording');
                
                // Таймер
                voiceSeconds = 0;
                voiceTimer = setInterval(() => {
                    voiceSeconds++;
                    const minutes = Math.floor(voiceSeconds / 60);
                    const seconds = voiceSeconds % 60;
                    document.getElementById('voiceTimer').textContent = 
                        `${minutes}:${seconds.toString().padStart(2, '0')}`;
                }, 1000);

                // Визуализация волн
                createVoiceWave();

            } catch (error) {
                console.error('Voice recording error:', error);
                alert('Не удалось получить доступ к микрофону');
            }
        }

        function stopVoiceRecord() {
            if (mediaRecorder && isRecording) {
                mediaRecorder.stop();
                isRecording = false;
                
                document.getElementById('voiceRecordBtn').classList.remove('recording');
                document.getElementById('voiceRecorder').classList.remove('recording');
                
                // Останавливаем все треки
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
            }
        }

        function cancelVoiceRecord() {
            stopVoiceRecord();
            document.getElementById('voiceRecorder').style.display = 'none';
            clearInterval(voiceTimer);
        }

        async function sendVoiceMessage() {
            if (mediaRecorder && audioChunks.length > 0) {
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    
                    // Создаем FormData для отправки
                    const formData = new FormData();
                    formData.append('voice', audioBlob, 'voice-message.webm');
                    
                    try {
                        const response = await fetch('/api/upload-voice', {
                            method: 'POST',
                            body: formData
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            socket.emit('send_voice_message', {
                                sender: currentUser.username,
                                voiceUrl: result.path,
                                duration: voiceSeconds
                            });
                            
                            addVoiceMessage(currentUser.username, result.path, voiceSeconds, true);
                        }
                    } catch (error) {
                        console.error('Voice upload error:', error);
                        alert('Ошибка отправки голосового сообщения');
                    }
                    
                    document.getElementById('voiceRecorder').style.display = 'none';
                    clearInterval(voiceTimer);
                };
                
                mediaRecorder.stop();
            }
        }

        function createVoiceWave() {
            const waveContainer = document.getElementById('voiceWave');
            waveContainer.innerHTML = '';
            
            for (let i = 0; i < 20; i++) {
                const bar = document.createElement('div');
                bar.className = 'voice-bar';
                bar.style.animationDelay = `${i * 0.1}s`;
                bar.style.height = `${Math.random() * 15 + 5}px`;
                waveContainer.appendChild(bar);
            }
        }

        function addVoiceMessage(sender, voiceUrl, duration, isOwn) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
            
            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-sender">${sender}</div>` : ''}
                <div class="voice-message">
                    <button class="voice-play-btn" onclick="playVoiceMessage('${voiceUrl}')">
                        <i class="fas fa-play"></i>
                    </button>
                    <div class="voice-duration">${duration}с</div>
                    <div class="voice-waveform"></div>
                </div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function playVoiceMessage(url) {
            const audio = new Audio(url);
            audio.play();
        }

        // Реальная отправка файлов
        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;

            const formData = new FormData();
            formData.append('file', file);

            try {
                const response = await fetch('/api/upload-file', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                
                if (result.success) {
                    socket.emit('send_file_message', {
                        sender: currentUser.username,
                        fileName: result.originalName,
                        fileUrl: result.path,
                        fileSize: result.size,
                        fileType: result.type
                    });
                    
                    addFileMessage(currentUser.username, result.originalName, result.path, result.size, result.type, true);
                }
            } catch (error) {
                console.error('File upload error:', error);
                alert('Ошибка отправки файла');
            }
            
            // Очищаем input
            event.target.value = '';
        }

        function addFileMessage(sender, fileName, fileUrl, fileSize, fileType, isOwn) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
            
            const fileIcon = getFileIcon(fileType);
            const sizeText = formatFileSize(fileSize);
            
            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-sender">${sender}</div>` : ''}
                <div class="file-message">
                    <div class="file-icon">${fileIcon}</div>
                    <div class="file-name">${fileName}</div>
                    <div class="file-size">${sizeText}</div>
                    <a href="${fileUrl}" class="file-download" download="${fileName}">
                        <i class="fas fa-download"></i> Скачать
                    </a>
                </div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function getFileIcon(fileType) {
            if (fileType.startsWith('image/')) return '<i class="fas fa-image"></i>';
            if (fileType.startsWith('video/')) return '<i class="fas fa-video"></i>';
            if (fileType.startsWith('audio/')) return '<i class="fas fa-music"></i>';
            if (fileType.includes('pdf')) return '<i class="fas fa-file-pdf"></i>';
            if (fileType.includes('word')) return '<i class="fas fa-file-word"></i>';
            if (fileType.includes('excel')) return '<i class="fas fa-file-excel"></i>';
            return '<i class="fas fa-file"></i>';
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // Остальные функции (звонки, сообщения, меню)...
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;

            socket.emit('send_message', {
                sender: currentUser.username,
                text: text
            });

            addMessage(currentUser.username, text, true);
            input.value = '';
        }

        function addMessage(sender, text, isOwn) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOwn ? 'sent' : 'received'}`;
            
            messageDiv.innerHTML = `
                ${!isOwn ? `<div class="message-sender">${sender}</div>` : ''}
                <div class="message-text">${text}</div>
                <div class="message-time">${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</div>
            `;

            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        function addSystemMessage(text) {
            const container = document.getElementById('messagesContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'system-message';
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Обработчики Enter
        document.getElementById('loginUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        document.getElementById('loginPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') login();
        });

        document.getElementById('registerUsername').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') register();
        });

        document.getElementById('registerPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') register();
        });

        document.getElementById('registerConfirmPassword').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') register();
        });

        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') sendMessage();
        });

        // Функции звонков (остаются из предыдущей версии)
        function startCallWithUser(username, type) {
            // Заглушка для звонков
            alert(`Звонок пользователю ${username} (${type})`);
        }

        function startGroupCall(type) {
            alert(`Групповой ${type === 'audio' ? 'аудио' : 'видео'} звонок запущен!`);
        }

        function updateOnlineUsers(users) {
            const container = document.getElementById('onlineUsersList');
            container.innerHTML = '';

            users.forEach(user => {
                const userElement = document.createElement('div');
                userElement.className = 'user-item';
                userElement.innerHTML = `
                    <div class="user-avatar-small" style="background: ${user.color}">
                        ${user.username.charAt(0).toUpperCase()}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 500;">${user.username}</div>
                    </div>
                    <div class="user-status"></div>
                    <div class="call-buttons-small">
                        <button class="call-btn-small audio-call-btn" onclick="startCallWithUser('${user.username}', 'audio')">
                            <i class="fas fa-phone"></i>
                        </button>
                        <button class="call-btn-small video-call-btn" onclick="startCallWithUser('${user.username}', 'video')">
                            <i class="fas fa-video"></i>
                        </button>
                    </div>
                `;
                container.appendChild(userElement);
            });
        }
    </script>
</body>
</html>
